/**
 * @module    mod_treasurehunt/ol3-layerswitcher
 * @package   mod_treasurehunt
 * @copyright 2016 onwards Adrian Rodriguez Fernandez <huorwhisp@gmail.com>
 * @author Adrian Rodriguez <huorwhisp@gmail.com>
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
!function(e,t){"function"==typeof define&&define.amd?define(["mod_treasurehunt/ol"],t):"object"==typeof module&&module.exports?module.exports=t(require("mod_treasurehunt/ol")):e.LayerSwitcher=t(e.ol)}(this,(function(e){return e.control.LayerSwitcher=function(t){var n=t||{},r=n.tipLabel?n.tipLabel:"Legend";this.mapListeners=[],this.hiddenClassName="ol-unselectable ol-control layer-switcher",e.control.LayerSwitcher.isTouchDevice_()&&(this.hiddenClassName+=" touch"),this.shownClassName="shown";var o=document.createElement("div");o.className=this.hiddenClassName;var i=document.createElement("button");i.setAttribute("title",r),o.appendChild(i),this.panel=document.createElement("div"),this.panel.className="panel",o.appendChild(this.panel),e.control.LayerSwitcher.enableTouchScroll_(this.panel);var a=this;i.onmouseover=function(e){a.showPanel()},i.onclick=function(e){e=e||window.event,a.showPanel(),e.preventDefault()},a.panel.onmouseout=function(e){e=e||window.event,a.panel.contains(e.toElement||e.relatedTarget)||a.hidePanel()},e.control.Control.call(this,{element:o,target:n.target})},e.inherits(e.control.LayerSwitcher,e.control.Control),e.control.LayerSwitcher.prototype.showPanel=function(){this.element.classList.contains(this.shownClassName)||(this.element.classList.add(this.shownClassName),this.renderPanel())},e.control.LayerSwitcher.prototype.hidePanel=function(){this.element.classList.contains(this.shownClassName)&&this.element.classList.remove(this.shownClassName)},e.control.LayerSwitcher.prototype.renderPanel=function(){for(this.ensureTopVisibleBaseLayerShown_();this.panel.firstChild;)this.panel.removeChild(this.panel.firstChild);var e=document.createElement("ul");this.panel.appendChild(e),this.renderLayers_(this.getMap(),e)},e.control.LayerSwitcher.prototype.setMap=function(t){for(var n=0;n<this.mapListeners.length;n++)e.Observable.unByKey(this.mapListeners[n]);if(this.mapListeners.length=0,e.control.Control.prototype.setMap.call(this,t),t){var r=this;this.mapListeners.push(t.on("pointerdown",(function(){r.hidePanel()}))),this.renderPanel()}},e.control.LayerSwitcher.prototype.ensureTopVisibleBaseLayerShown_=function(){var t;e.control.LayerSwitcher.forEachRecursive(this.getMap(),(function(e,n,r){"base"===e.get("type")&&e.getVisible()&&(t=e)})),t&&this.setVisible_(t,!0)},e.control.LayerSwitcher.prototype.setVisible_=function(t,n){var r=this.getMap();t.setVisible(n),n&&"base"===t.get("type")&&e.control.LayerSwitcher.forEachRecursive(r,(function(e,n,r){e!=t&&"base"===e.get("type")&&e.setVisible(!1)}))},e.control.LayerSwitcher.prototype.renderLayer_=function(t,n){var r=this,o=document.createElement("li"),i=t.get("title"),a=e.control.LayerSwitcher.uuid(),s=document.createElement("label");if(t.getLayers&&!t.get("combine")){o.className="group",s.innerHTML=i,o.appendChild(s);var c=document.createElement("ul");o.appendChild(c),this.renderLayers_(t,c)}else{o.className="layer";var l=document.createElement("input");"base"===t.get("type")?(l.type="radio",l.name="base"):l.type="checkbox",l.id=a,l.checked=t.get("visible"),l.onchange=function(e){r.setVisible_(t,e.target.checked)},o.appendChild(l),s.htmlFor=a,s.innerHTML=i;var h=this.getMap().getView().getResolution();(h>t.getMaxResolution()||h<t.getMinResolution())&&(s.className+=" disabled"),o.appendChild(s)}return o},e.control.LayerSwitcher.prototype.renderLayers_=function(e,t){for(var n,r=e.getLayers().getArray().slice().reverse(),o=0;o<r.length;o++)(n=r[o]).get("title")&&t.appendChild(this.renderLayer_(n,o))},e.control.LayerSwitcher.forEachRecursive=function(t,n){t.getLayers().forEach((function(t,r,o){n(t,r,o),t.getLayers&&e.control.LayerSwitcher.forEachRecursive(t,n)}))},e.control.LayerSwitcher.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},e.control.LayerSwitcher.enableTouchScroll_=function(t){if(e.control.LayerSwitcher.isTouchDevice_()){var n=0;t.addEventListener("touchstart",(function(e){n=this.scrollTop+e.touches[0].pageY}),!1),t.addEventListener("touchmove",(function(e){this.scrollTop=n-e.touches[0].pageY}),!1)}},e.control.LayerSwitcher.isTouchDevice_=function(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}},e.control.LayerSwitcher}));